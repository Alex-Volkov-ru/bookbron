name: ğŸš€ Deploy Booking System

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build_backend:
    name: ğŸ³ Build & Push Backend
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build & Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./env/backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/booking_backend:latest

      - name: ğŸ“ Ğ˜Ñ‚Ğ¾Ğ³ (backend)
        run: |
          echo "âœ… Backend ÑĞ¾Ğ±Ñ€Ğ°Ğ½ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑˆĞµĞ½: ${{ secrets.DOCKER_USERNAME }}/booking_backend:latest" >> $GITHUB_STEP_SUMMARY

  build_frontend:
    name: ğŸ³ Build & Push Frontend
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build & Push Frontend Production Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./env/frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/booking_frontend:latest

      - name: ğŸ“ Ğ˜Ñ‚Ğ¾Ğ³ (frontend)
        run: |
          echo "âœ… Frontend ÑĞ¾Ğ±Ñ€Ğ°Ğ½ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑˆĞµĞ½: ${{ secrets.DOCKER_USERNAME }}/booking_frontend:latest" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ğŸš€ Deploy on server
    runs-on: ubuntu-latest
    needs: [ build_backend, build_frontend ]
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡, ÑƒĞ±Ğ¸Ñ€Ğ°Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ»Ğ¸ÑˆĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹/Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹
          echo "${{ secrets.SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ĞºĞ»ÑÑ‡Ğ°
          ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1 || (echo "âŒ SSH ĞºĞ»ÑÑ‡ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½" && exit 1)
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€ Ğ² known_hosts
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -t rsa,ecdsa,ed25519 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          echo "âœ… SSH Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ»ĞµĞ½" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“ Ensure remote dirs exist
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p '${{ secrets.PROJECT_DIR }}/env/frontend' '${{ secrets.PROJECT_DIR }}/env/nginx' '${{ secrets.PROJECT_DIR }}/scripts'"
          echo "ğŸ“‚ Ğ£Ğ±ĞµĞ´Ğ¸Ğ»Ğ¸ÑÑŒ, Ñ‡Ñ‚Ğ¾ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Copy files & restart services
        run: |
          echo "ğŸ“¦ ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€"
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SSH_PORT }} docker-compose.production.yml \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.PROJECT_DIR }}/
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SSH_PORT }} env/frontend/nginx.conf \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.PROJECT_DIR }}/env/frontend/
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SSH_PORT }} env/frontend/local.conf \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.PROJECT_DIR }}/env/frontend/
          scp -i ~/.ssh/id_rsa -P ${{ secrets.SSH_PORT }} scripts/setup_server.sh \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.PROJECT_DIR }}/scripts/ 2>/dev/null || true

          echo "ğŸš€ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑÑ‚ĞµĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²"
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          set -e
          cd ${{ secrets.PROJECT_DIR }}
          export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ booking
          docker stop \$(docker ps -q --filter "name=booking") 2>/dev/null || true
          docker rm \$(docker ps -aq --filter "name=booking") 2>/dev/null || true
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ
          docker compose -f docker-compose.production.yml pull
          docker compose -f docker-compose.production.yml down
          docker compose -f docker-compose.production.yml up -d
          EOF

      - name: ğŸ“ Ğ˜Ñ‚Ğ¾Ğ³ (deploy)
        run: |
          echo "âœ… Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY

  verify:
    name: âœ… Verify deployment
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -t rsa ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” docker ps
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
          echo "ğŸ§ª ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ğŸ“£ Notify Telegram
    runs-on: ubuntu-latest
    if: always()
    needs: [ deploy ]
    steps:
      - name: ğŸ“¢ Send message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸš€ Booking System Deployment *${{ needs.deploy.result }}*
            ğŸ“¦ Repo: https://github.com/${{ github.repository }}
            ğŸ”— Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
